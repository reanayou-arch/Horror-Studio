<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Horror-Studio ‚Äî –ò–≥—Ä–∞</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #222;
      color: white;
    }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .topbar {
      height: 55px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 10px;
    }

    .back-btn {
      font-size: 22px;
      cursor: pointer;
    }

    .story-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #444;
      overflow: hidden;
    }

    .story-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .story-title {
      flex: 1;
      font-size: 15px;
      font-weight: 600;
    }

    .lock {
      font-size: 18px;
      opacity: 0.8;
    }

    .menu-btn {
      font-size: 22px;
      cursor: pointer;
    }

    /* –ß–∞—Ç */
    .chat-area {
      height: calc(100vh - 110px);
      overflow-y: auto;
      padding: 12px;
    }

    .msg {
      display: flex;
      margin: 10px 0;
      align-items: flex-end;
      gap: 8px;
    }

    .msg.npc {
      justify-content: flex-start;
    }

    .msg.player {
      justify-content: flex-end;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 75%;
      font-size: 14px;
      line-height: 1.4;
    }

    .npc .bubble {
      background: rgba(255,255,255,0.12);
    }

    .player .bubble {
      background: rgba(200,0,0,0.55);
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      overflow: hidden;
      background: #555;
      flex-shrink: 0;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .input-bar {
      height: 55px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: none;
      outline: none;
      background: #333;
      color: white;
      font-size: 14px;
    }

    .send-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: darkred;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .upload-box {
      padding: 10px;
      text-align: center;
      background: rgba(255,255,255,0.06);
    }
  </style>
</head>

<body>

  <!-- –í–µ—Ä—Ö -->
  <div class="topbar">
    <div class="back-btn">‚Üê</div>

    <div class="story-avatar" id="storyAvatar"></div>

    <div class="story-title" id="storyTitle">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</div>

    <div class="lock">üîí</div>
    <div class="menu-btn">‚ãÆ</div>
  </div>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
  <div class="upload-box">
    <input type="file" accept=".json" onchange="loadStory(event)">
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-area" id="chat"></div>

  <!-- –í–≤–æ–¥ -->
  <div class="input-bar">
    <div class="icon-btn">Ôºã</div>
    <div class="icon-btn">üòä</div>

    <input id="playerInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />

    <div class="send-btn" onclick="sendMessage()">‚û§</div>
  </div>

<script>
  let storyData = null;
  let chatHistory = [];

  function addMessage(text, type="npc", avatar=null) {
    const chat = document.getElementById("chat");

    const msg = document.createElement("div");
    msg.className = "msg " + type;

    if(type === "npc") {
      const av = document.createElement("div");
      av.className = "avatar";

      if(avatar) {
        av.innerHTML = `<img src="${avatar}">`;
      }

      msg.appendChild(av);
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerText = text;

    msg.appendChild(bubble);
    chat.appendChild(msg);

    chat.scrollTop = chat.scrollHeight;
  }

  function loadStory(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      storyData = JSON.parse(e.target.result);

      document.getElementById("storyTitle").innerText = storyData.title;

      // –∞–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏
      if(storyData.avatar){
        document.getElementById("storyAvatar").innerHTML =
          `<img src="${storyData.avatar}">`;
      }

      addMessage("–ù–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏: " + storyData.setup.startSituation, "npc");

      chatHistory.push({
        role: "system",
        content: storyData.setup.startSituation
      });
    };

    reader.readAsText(file);
  }

  async function sendMessage() {
    const input = document.getElementById("playerInput");
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "player");
    input.value = "";

    chatHistory.push({ role: "user", content: text });

    // üî• –∑–∞–ø—Ä–æ—Å –Ω–∞ Render —Å–µ—Ä–≤–µ—Ä
    const response = await fetch("https://horror-studio.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: chatHistory,
        characters: storyData.characters
      })
    });

    const data = await response.json();

    let replyText = data.reply;

    // –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
    try {
      const parsed = JSON.parse(replyText);

      const npcName = parsed.character;
      const npcMessage = parsed.message;

      const npc = storyData.characters.find(c => c.name === npcName);

      addMessage(npcMessage, "npc", npc?.avatar);

      chatHistory.push({ role: "assistant", content: npcMessage });

    } catch {
      addMessage(replyText, "npc");
    }
  }
</script>

</body>
</html>
