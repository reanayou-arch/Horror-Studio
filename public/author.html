<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horror-Studio ‚Äî –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∞</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: white;
    }

    .overlay {
      min-height: 100vh;
      padding: 15px 0;
      background: rgba(0,0,0,0.88);
    }

    .container {
      width: 95%;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 26px;
      margin: 20px 0;
      font-weight: 900;
    }

    .planet {
      text-align: center;
      font-size: 22px;
      margin-top: -10px;
      opacity: 0.8;
    }

    .block {
      background: rgba(255,255,255,0.06);
      padding: 14px;
      border-radius: 14px;
      margin-top: 14px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      margin-top: 15px;
    }

    .gray {
      background: rgba(255,255,255,0.10);
      color: white;
    }

    .red {
      background: rgba(140,0,0,0.85);
      color: white;
    }

    input, textarea {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 12px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.14);
      color: white;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .story-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      margin-top: 10px;
      position: relative;
    }

    .story-title {
      font-weight: 700;
    }

    .dots {
      cursor: pointer;
      font-size: 22px;
      padding: 0 10px;
    }

    .menu-popup {
      position: absolute;
      right: 10px;
      top: 45px;
      background: #222;
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 999;
      min-width: 160px;
    }

    .menu-popup button {
      background: none;
      border: none;
      color: white;
      padding: 10px;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .menu-popup button:hover {
      background: rgba(255,255,255,0.08);
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255,255,255,0.12);
      margin: auto;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .character-card {
      background: rgba(255,255,255,0.05);
      padding: 14px;
      border-radius: 14px;
      margin-top: 14px;
      text-align: center;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff6666;
      cursor: pointer;
      margin-top: 10px;
    }

    .version {
      text-align: center;
      opacity: 0.5;
      margin-top: 25px;
    }
  </style>
</head>

<body>
<div class="overlay">
<div class="container">

  <!-- MENU -->
  <div id="menuScreen">
    <h1>Horror-Studio</h1>
    <div class="planet">ü™ê</div>

    <button class="btn gray" onclick="openEditor()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

    <div class="block">
      <h2>–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–π:</h2>
      <div id="storyList"></div>
    </div>

    <div class="version">(Render Release V3.0.1)</div>
  </div>

  <!-- EDITOR -->
  <div id="editorScreen" style="display:none;">

    <h1>–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</h1>

    <div class="block">
      <h2>–ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏</h2>

      <div class="avatar">
        <img id="storyAvatarPreview" style="display:none;">
      </div>

      <button class="btn gray" onclick="document.getElementById('storyAvatar').click()">
        üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
      </button>

      <input type="file" id="storyAvatar" accept="image/*" style="display:none;"
        onchange="uploadStoryAvatar(event)">
    </div>

    <div class="block">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
      <input id="storyTitle">

      <label>–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ò–ò:</label>
      <textarea id="storyDescription"></textarea>
    </div>

    <div class="block">
      <label>–ü—Ä–æ—à–ª–æ–µ:</label>
      <textarea id="storyPast"></textarea>

      <label>–ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:</label>
      <textarea id="storyStart"></textarea>
    </div>

    <div class="block">
      <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
      <div id="characterList"></div>

      <button class="btn gray" onclick="addCharacter()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
    </div>

    <button class="btn red" onclick="saveStory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn gray" onclick="backToMenu()">‚Üê –ù–∞–∑–∞–¥</button>

  </div>

</div>
</div>

<script>
let characters = [];
let storyAvatar = null;

/* Compress */
function compressImage(file, callback){
  const img = new Image();
  const reader = new FileReader();
  reader.onload = e => img.src = e.target.result;

  img.onload = ()=>{
    const canvas = document.createElement("canvas");
    canvas.width = 256;
    canvas.height = 256;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img,0,0,256,256);

    callback(canvas.toDataURL("image/jpeg",0.7));
  };

  reader.readAsDataURL(file);
}

/* Menu */
function loadStories(){
  const list=document.getElementById("storyList");
  list.innerHTML="";

  const stories=JSON.parse(localStorage.getItem("stories")||"[]");

  stories.forEach(story=>{
    const item=document.createElement("div");
    item.className="story-item";

    item.innerHTML=`
      <div class="story-title">${story.title}</div>
      <div class="dots" onclick="togglePopup(event,'${story.id}')">‚ãÆ</div>

      <div class="menu-popup" id="popup_${story.id}">
        <button onclick="openStory('${story.id}')">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
        <button onclick="deleteStory('${story.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;

    list.appendChild(item);
  });
}

function togglePopup(e,id){
  e.stopPropagation();
  document.querySelectorAll(".menu-popup").forEach(p=>{
    if(p.id!=="popup_"+id) p.style.display="none";
  });

  const popup=document.getElementById("popup_"+id);
  popup.style.display = popup.style.display==="flex" ? "none" : "flex";
}

document.body.addEventListener("click",()=>{
  document.querySelectorAll(".menu-popup").forEach(p=>p.style.display="none");
});

/* Editor */
function openEditor(){
  resetEditor();
  document.getElementById("menuScreen").style.display="none";
  document.getElementById("editorScreen").style.display="block";
}

function backToMenu(){
  document.getElementById("editorScreen").style.display="none";
  document.getElementById("menuScreen").style.display="block";
  loadStories();
}

function resetEditor(){
  characters=[];
  storyAvatar=null;
  document.getElementById("storyAvatarPreview").style.display="none";
  document.getElementById("storyTitle").value="";
  document.getElementById("storyDescription").value="";
  document.getElementById("storyPast").value="";
  document.getElementById("storyStart").value="";
  renderCharacters();
}

/* Story Avatar */
function uploadStoryAvatar(e){
  const file=e.target.files[0];
  if(!file) return;

  compressImage(file,(result)=>{
    storyAvatar=result;
    const img=document.getElementById("storyAvatarPreview");
    img.src=result;
    img.style.display="block";
  });
}

/* Characters */
function addCharacter(){
  characters.push({
    id:"ch_"+Date.now(),
    name:"",
    personality:"",
    avatar:null
  });
  renderCharacters();
}

function renderCharacters(){
  const list=document.getElementById("characterList");
  list.innerHTML="";

  characters.forEach(char=>{
    const card=document.createElement("div");
    card.className="character-card";

    card.innerHTML=`
      <div class="avatar">
        ${char.avatar?`<img src="${char.avatar}">`:""}
      </div>

      <label>–ò–º—è:</label>
      <input value="${char.name}" oninput="char.name=this.value">

      <label>–•–∞—Ä–∞–∫—Ç–µ—Ä:</label>
      <textarea oninput="char.personality=this.value">${char.personality}</textarea>

      <input type="file" accept="image/*"
        onchange="uploadCharAvatar(event,'${char.id}')">

      <button class="delete-btn" onclick="deleteCharacter('${char.id}')">
        ‚ùå –£–¥–∞–ª–∏—Ç—å
      </button>
    `;

    list.appendChild(card);
  });
}

function uploadCharAvatar(e,id){
  const file=e.target.files[0];
  if(!file) return;

  compressImage(file,(result)=>{
    const c=characters.find(x=>x.id===id);
    c.avatar=result;
    renderCharacters();
  });
}

function deleteCharacter(id){
  characters=characters.filter(x=>x.id!==id);
  renderCharacters();
}

/* Save */
function saveStory(){
  const story={
    id:"story_"+Date.now(),
    title: document.getElementById("storyTitle").value,
    description: document.getElementById("storyDescription").value,
    avatar: storyAvatar,
    setup:{
      past: document.getElementById("storyPast").value,
      startSituation: document.getElementById("storyStart").value
    },
    characters
  };

  let stories=JSON.parse(localStorage.getItem("stories")||"[]");
  stories.push(story);
  localStorage.setItem("stories",JSON.stringify(stories));

  alert("–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
  backToMenu();
}

/* Play */
function openStory(id){
  const stories=JSON.parse(localStorage.getItem("stories")||"[]");
  const story=stories.find(s=>s.id===id);

  localStorage.setItem("active_story",JSON.stringify(story));
  window.location.href="play.html";
}

function deleteStory(id){
  let stories=JSON.parse(localStorage.getItem("stories")||"[]");
  stories=stories.filter(s=>s.id!==id);
  localStorage.setItem("stories",JSON.stringify(stories));
  loadStories();
}

loadStories();
</script>

</body>
</html>
