<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Horror-Studio ‚Äî –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∞</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: white;
    }

    .overlay {
      min-height: 100vh;
      padding: 15px 0;
    }

    .container {
      width: 95%;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .block {
      background: rgba(255,255,255,0.06);
      padding: 16px;
      border-radius: 16px;
      margin-top: 16px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      font-size: 13px;
    }

    input, textarea {
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      border-radius: 12px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.14);
      color: white;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .avatar-preview {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      overflow: hidden;
      margin: auto;
      background: rgba(255,255,255,0.12);
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .add-btn, .save-btn {
      width: 100%;
      margin-top: 15px;
      padding: 14px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      color: white;
    }

    .add-btn {
      background: rgba(255,255,255,0.12);
    }

    .save-btn {
      background: darkred;
    }

    .character-card {
      background: rgba(255,255,255,0.05);
      padding: 14px;
      border-radius: 14px;
      margin-top: 14px;
      text-align: center;
    }

    .delete-btn {
      margin-top: 10px;
      border: none;
      background: none;
      color: #ff6666;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="overlay">
<div class="container">

<h1>–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</h1>

<!-- –ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏ -->
<div class="block">
  <h2>–ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏</h2>

  <div class="avatar-preview" id="storyAvatarPreview"></div>

  <input type="file" accept="image/*" onchange="uploadStoryAvatar(event)">
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
<div class="block">
  <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
  <input id="storyTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏..."/>

  <label>–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ò–ò:</label>
  <textarea id="storyDescription"></textarea>
</div>

<!-- –°–µ—Ç–∞–ø -->
<div class="block">
  <label>–ü—Ä–æ—à–ª–æ–µ:</label>
  <textarea id="storyPast"></textarea>

  <label>–ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:</label>
  <textarea id="storyStart"></textarea>
</div>

<!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ -->
<div class="block">
  <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
  <div id="characterList"></div>

  <button class="add-btn" onclick="addCharacter()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
</div>

<!-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
<button class="save-btn" onclick="saveStory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>

</div>
</div>

<script>
let characters = [];
let storyAvatar = null;

/* ===== –ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏ ===== */
function uploadStoryAvatar(event){
  const file = event.target.files[0];
  if(!file) return;

  compressImage(file, (result)=>{
    storyAvatar = result;
    document.getElementById("storyAvatarPreview").innerHTML =
      `<img src="${storyAvatar}">`;
  });
}

/* ===== –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ ===== */
function addCharacter(){
  const id = "ch_" + Date.now();

  characters.push({
    id,
    name:"",
    role:"",
    personality:"",
    avatar:null
  });

  renderCharacters();
}

function renderCharacters(){
  const list = document.getElementById("characterList");
  list.innerHTML = "";

  characters.forEach(char=>{
    const card = document.createElement("div");
    card.className="character-card";

    card.innerHTML=`
      <div class="avatar-preview">
        ${char.avatar ? `<img src="${char.avatar}">` : ""}
      </div>

      <label>–ò–º—è:</label>
      <input value="${char.name}"
        oninput="updateChar('${char.id}','name',this.value)">

      <label>–†–æ–ª—å:</label>
      <input value="${char.role}"
        oninput="updateChar('${char.id}','role',this.value)">

      <label>–•–∞—Ä–∞–∫—Ç–µ—Ä:</label>
      <textarea oninput="updateChar('${char.id}','personality',this.value)">
${char.personality}</textarea>

      <label>–§–æ—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
      <input type="file" accept="image/*"
        onchange="uploadCharAvatar(event,'${char.id}')">

      <button class="delete-btn"
        onclick="deleteCharacter('${char.id}')">
        ‚ùå –£–¥–∞–ª–∏—Ç—å
      </button>
    `;

    list.appendChild(card);
  });
}

function updateChar(id,field,value){
  const c = characters.find(x=>x.id===id);
  if(c) c[field]=value;
}

function deleteCharacter(id){
  characters = characters.filter(x=>x.id!==id);
  renderCharacters();
}

/* ===== –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ===== */
function compressImage(file, callback){
  const img = new Image();
  const reader = new FileReader();

  reader.onload = e => img.src = e.target.result;

  img.onload = ()=>{
    const canvas = document.createElement("canvas");
    canvas.width = 256;
    canvas.height = 256;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(img,0,0,256,256);

    const compressed = canvas.toDataURL("image/jpeg",0.7);
    callback(compressed);
  };

  reader.readAsDataURL(file);
}

function uploadCharAvatar(event,id){
  const file = event.target.files[0];
  if(!file) return;

  compressImage(file,(result)=>{
    const c = characters.find(x=>x.id===id);
    c.avatar=result;
    renderCharacters();
  });
}

/* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===== */
function saveStory(){
  const story = {
    id:"story_"+Date.now(),
    avatar: storyAvatar,
    title: document.getElementById("storyTitle").value,
    description: document.getElementById("storyDescription").value,
    setup:{
      past: document.getElementById("storyPast").value,
      startSituation: document.getElementById("storyStart").value
    },
    characters
  };

  const json = JSON.stringify(story,null,2);
  const blob = new Blob([json],{type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href=url;
  a.download = story.title ? story.title+".json" : "story.json";
  a.click();

  URL.revokeObjectURL(url);
  alert("–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
}
</script>

</body>
</html>
