<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horror-Studio ‚Äî –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∞</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: white;
    }

    .overlay {
      background: rgba(0, 0, 0, 0.88);
      min-height: 100vh;
      padding: 15px 0;
    }

    .container {
      width: 95%;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 26px;
      margin: 20px 0;
      font-weight: 900;
    }

    .planet {
      text-align: center;
      font-size: 22px;
      margin-top: -10px;
      opacity: 0.8;
    }

    .block {
      background: rgba(255, 255, 255, 0.06);
      padding: 14px;
      border-radius: 14px;
      margin-top: 14px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      font-size: 13px;
      opacity: 0.9;
    }

    input, textarea {
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      outline: none;
      background: rgba(255, 255, 255, 0.14);
      color: white;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      margin-top: 15px;
    }

    .red {
      background: rgba(140, 0, 0, 0.85);
      color: white;
    }

    .gray {
      background: rgba(255,255,255,0.10);
      color: white;
    }

    .character-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.05);
      margin-top: 14px;
      text-align: center;
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.12);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff6666;
      cursor: pointer;
      font-size: 13px;
    }

    /* ===== MENU LIST ===== */

    .story-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      margin-top: 10px;
    }

    .story-title {
      font-weight: 700;
    }

    .dots {
      cursor: pointer;
      font-size: 22px;
      padding: 0 10px;
    }

    .menu-popup {
      position: absolute;
      background: #222;
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 999;
    }

    .menu-popup button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
    }

    .menu-popup button:hover {
      background: rgba(255,255,255,0.08);
    }

    .version {
      text-align: center;
      opacity: 0.5;
      margin-top: 30px;
    }
  </style>
</head>

<body>
<div class="overlay">
  <div class="container">

    <!-- ‚úÖ MENU SCREEN -->
    <div id="menuScreen">
      <h1>Horror-Studio</h1>
      <div class="planet">ü™ê</div>

      <button class="btn gray" onclick="openEditor()">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
      </button>

      <button class="btn gray" onclick="openFile()">
        üìÇ –û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é
      </button>

      <div class="block">
        <h2>–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–π:</h2>
        <div id="storyList"></div>
      </div>

      <div class="version">(–í–µ—Ä—Å–∏—è –ø–∞–Ω–µ–ª–∏: V0.2.0)</div>
    </div>

    <!-- ‚úÖ EDITOR SCREEN -->
    <div id="editorScreen" style="display:none;">

      <h1>–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</h1>

      <!-- –ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏ -->
      <div class="block">
        <h2>–ê–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏</h2>
        <div class="avatar" style="margin:auto;">
          <img id="storyAvatarPreview" style="display:none;">
        </div>
        <button class="btn gray" onclick="document.getElementById('storyAvatar').click()">
          üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –∏—Å—Ç–æ—Ä–∏–∏
        </button>
        <input type="file" id="storyAvatar" accept="image/*" style="display:none;"
          onchange="uploadStoryAvatar(event)">
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
      <div class="block">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input id="storyTitle">

        <label>–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ò–ò:</label>
        <textarea id="storyDescription"></textarea>
      </div>

      <!-- –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è -->
      <div class="block">
        <label>–ü—Ä–æ—à–ª–æ–µ:</label>
        <textarea id="storyPast"></textarea>

        <label>–ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:</label>
        <textarea id="storyStart"></textarea>
      </div>

      <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ -->
      <div class="block">
        <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
        <div id="characterList"></div>

        <button class="btn gray" onclick="addCharacter()">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        </button>
      </div>

      <!-- Save -->
      <button class="btn red" onclick="saveStory()">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
      </button>

      <button class="btn gray" onclick="backToMenu()">
        ‚Üê –ù–∞–∑–∞–¥
      </button>
    </div>

    <!-- hidden file loader -->
    <input type="file" id="openJson" accept=".json" style="display:none;" onchange="importStory(event)">
  </div>
</div>

<script>
let characters = [];
let storyAvatar = null;
let editingId = null;

/* ===== MENU ===== */

function loadStories() {
  const list = document.getElementById("storyList");
  list.innerHTML = "";

  const stories = JSON.parse(localStorage.getItem("stories") || "[]");

  stories.forEach(story => {
    const item = document.createElement("div");
    item.className = "story-item";

    item.innerHTML = `
      <div class="story-title">${story.title}</div>
      <div class="dots" onclick="openDots(event,'${story.id}')">‚ãÆ</div>
      <div class="menu-popup" id="popup_${story.id}">
        <button onclick="openStory('${story.id}')">üìñ –û—Ç–∫—Ä—ã—Ç—å</button>
        <button onclick="downloadStory('${story.id}')">‚¨á –°–∫–∞—á–∞—Ç—å</button>
        <button onclick="editStory('${story.id}')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteStory('${story.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;

    list.appendChild(item);
  });
}

function openDots(e,id){
  e.stopPropagation();
  document.querySelectorAll(".menu-popup").forEach(p=>p.style.display="none");
  const popup=document.getElementById("popup_"+id);
  popup.style.display="flex";
  popup.style.left=e.pageX+"px";
  popup.style.top=e.pageY+"px";
}

document.body.addEventListener("click",()=>{
  document.querySelectorAll(".menu-popup").forEach(p=>p.style.display="none");
});

/* ===== EDITOR ===== */

function openEditor(){
  editingId=null;
  resetEditor();
  document.getElementById("menuScreen").style.display="none";
  document.getElementById("editorScreen").style.display="block";
}

function backToMenu(){
  document.getElementById("editorScreen").style.display="none";
  document.getElementById("menuScreen").style.display="block";
  loadStories();
}

function resetEditor(){
  characters=[];
  storyAvatar=null;
  document.getElementById("storyAvatarPreview").style.display="none";
  document.getElementById("storyTitle").value="";
  document.getElementById("storyDescription").value="";
  document.getElementById("storyPast").value="";
  document.getElementById("storyStart").value="";
  renderCharacters();
}

/* ===== AVATAR STORY ===== */

function uploadStoryAvatar(e){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    storyAvatar=ev.target.result;
    const img=document.getElementById("storyAvatarPreview");
    img.src=storyAvatar;
    img.style.display="block";
  };
  reader.readAsDataURL(file);
}

/* ===== CHARACTERS ===== */

function addCharacter(){
  characters.push({
    id:"ch_"+Date.now(),
    name:"",
    role:"",
    personality:"",
    avatar:null
  });
  renderCharacters();
}

function renderCharacters(){
  const list=document.getElementById("characterList");
  list.innerHTML="";

  characters.forEach(char=>{
    const card=document.createElement("div");
    card.className="character-card";

    card.innerHTML=`
      <div class="avatar">
        ${char.avatar?`<img src="${char.avatar}">`:""}
      </div>

      <label>–ò–º—è:</label>
      <input value="${char.name}" oninput="updateChar('${char.id}','name',this.value)">

      <label>–†–æ–ª—å:</label>
      <input value="${char.role}" oninput="updateChar('${char.id}','role',this.value)">

      <label>–•–∞—Ä–∞–∫—Ç–µ—Ä:</label>
      <textarea oninput="updateChar('${char.id}','personality',this.value)">${char.personality}</textarea>

      <label>–§–æ—Ç–æ:</label>
      <input type="file" accept="image/*" onchange="uploadAvatar(event,'${char.id}')">

      <button class="delete-btn" onclick="deleteCharacter('${char.id}')">
        ‚ùå –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      </button>
    `;
    list.appendChild(card);
  });
}

function updateChar(id,field,value){
  const c=characters.find(x=>x.id===id);
  if(c) c[field]=value;
}

function deleteCharacter(id){
  characters=characters.filter(x=>x.id!==id);
  renderCharacters();
}

function uploadAvatar(e,id){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    const c=characters.find(x=>x.id===id);
    c.avatar=ev.target.result;
    renderCharacters();
  };
  reader.readAsDataURL(file);
}

/* ===== SAVE STORY ===== */

function saveStory(){
  const story={
    id: editingId || "story_"+Date.now(),
    title: document.getElementById("storyTitle").value,
    description: document.getElementById("storyDescription").value,
    avatar: storyAvatar,
    setup:{
      past: document.getElementById("storyPast").value,
      startSituation: document.getElementById("storyStart").value
    },
    characters
  };

  let stories=JSON.parse(localStorage.getItem("stories")||"[]");

  stories = stories.filter(s=>s.id!==story.id);
  stories.push(story);

  localStorage.setItem("stories",JSON.stringify(stories));

  // –°–∫–∞—á–∞—Ç—å JSON
  downloadObject(story, story.title+".json");

  alert("–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
  backToMenu();
}

/* ===== ACTIONS ===== */

function downloadObject(obj,filename){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  a.click();
  URL.revokeObjectURL(url);
}

function downloadStory(id){
  const stories=JSON.parse(localStorage.getItem("stories")||"[]");
  const story=stories.find(s=>s.id===id);
  downloadObject(story,story.title+".json");
}

function deleteStory(id){
  let stories=JSON.parse(localStorage.getItem("stories")||"[]");
  stories=stories.filter(s=>s.id!==id);
  localStorage.setItem("stories",JSON.stringify(stories));
  loadStories();
}

function editStory(id){
  const stories=JSON.parse(localStorage.getItem("stories")||"[]");
  const story=stories.find(s=>s.id===id);

  editingId=story.id;
  openEditor();

  document.getElementById("storyTitle").value=story.title;
  document.getElementById("storyDescription").value=story.description;
  document.getElementById("storyPast").value=story.setup.past;
  document.getElementById("storyStart").value=story.setup.startSituation;

  storyAvatar=story.avatar;
  if(storyAvatar){
    const img=document.getElementById("storyAvatarPreview");
    img.src=storyAvatar;
    img.style.display="block";
  }

  characters=story.characters || [];
  renderCharacters();
}

function openStory(id){
  alert("–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é: —Å–∫–æ—Ä–æ –ø–æ–¥–∫–ª—é—á–∏–º –ø–µ—Ä–µ—Ö–æ–¥ –≤ play.html");
}

function openFile(){
  document.getElementById("openJson").click();
}

function importStory(e){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    const story=JSON.parse(ev.target.result);

    let stories=JSON.parse(localStorage.getItem("stories")||"[]");
    stories.push(story);
    localStorage.setItem("stories",JSON.stringify(stories));

    loadStories();
    alert("–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
  };
  reader.readAsText(file);
}

/* INIT */
loadStories();
</script>
</body>
</html>
